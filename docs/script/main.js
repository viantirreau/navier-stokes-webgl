!function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=9)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this._gl=e}return e.prototype.gl=function(){return this._gl},e}();t.default=n},function(e,t,r){},function(e,t,r){"use strict";var n,i=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(t,r,n){var i=e.call(this,t)||this;return i.id=t.createFramebuffer(),i.width=r,i.height=n,i}return i(t,e),t.prototype.bind=function(t,r){void 0===r&&(r=null);var n=e.prototype.gl.call(this);n.bindFramebuffer(n.FRAMEBUFFER,this.id),n.viewport(0,0,this.width,this.height);for(var i=0;i<t.length;++i)n.framebufferTexture2D(n.FRAMEBUFFER,n["COLOR_ATTACHMENT"+i],n.TEXTURE_2D,t[i],0);r&&(n.bindRenderbuffer(n.RENDERBUFFER,r),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,r))},t.bindDefault=function(e){e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight)},t.prototype.freeGLResources=function(){e.prototype.gl.call(this).deleteFramebuffer(this.id),this.id=null},t}(o(r(0)).default);t.default=a},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.bladeInfo=t.fluid=t.display=t.brush=t.bind=t.mouse=void 0;var a=o(r(7));r(1);var s=function(){function e(){var e=this;this._posInPx=[0,0],this._pivotInPx=[0,0],this.setPosInPx([0,0]),this.setMovementInPx([0,0]),Page.Canvas.Observers.mouseMove.push((function(t,r){var n=Page.Canvas.getSize();e.setPosInPx([n[0]*t,n[1]*(1-r)])})),Page.Canvas.Observers.mouseDown.push((function(){e.setMovementInPx([0,0]),e._pivotInPx=e._posInPx}))}return Object.defineProperty(e.prototype,"posInPx",{get:function(){return this._posInPx},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pos",{get:function(){return this._pos},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"movementInPx",{get:function(){return this._movementInPx},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"movement",{get:function(){return this._movement},enumerable:!1,configurable:!0}),e.prototype.setPosInPx=function(e){var t=[this._pivotInPx[0]-e[0],this._pivotInPx[1]-e[1]],r=Math.sqrt(t[0]*t[0]+t[1]*t[1]);r>16&&(t[0]*=16/r,t[1]*=16/r,this._pivotInPx[0]=e[0]+t[0],this._pivotInPx[1]=e[1]+t[1]);var n=[-t[0]/16,-t[1]/16];this.setMovementInPx(n),this._posInPx=e,this._pos=this.setRelative(e)},e.prototype.setMovementInPx=function(e){this._movementInPx=e,this._movement=this.setRelative(e)},e.prototype.setRelative=function(e){var t=Page.Canvas.getSize();return[e[0]/t[0],e[1]/t[1]]},e}(),u=new s;t.mouse=u;var l={radius:10,strength:100};t.brush=l;var c={stream:!0,streamHeight:.3};t.fluid=c;var d={velocity:!0,pressure:!0,brush:!0,obstacles:!0};t.display=d;var f={radius:.15,centerOffset:.1,bladeCount:4};t.bladeInfo=f,t.bind=function(e){!function(e){var t=function(t){var r=+t[0];e.reset(r,r)};Page.Tabs.addObserver("resolution",t),t(Page.Tabs.getValues("resolution")),a.allExtensionsLoaded||(Page.Controls.setVisibility("float-texture-checkbox-id",!1),Page.Checkbox.setChecked("float-texture-checkbox-id",!1));var r=function(t){e.useFloatTextures=t};Page.Checkbox.addObserver("float-texture-checkbox-id",r),r(Page.Checkbox.isChecked("float-texture-checkbox-id"));var n=function(t){e.minNbIterations=t};Page.Range.addObserver("solver-steps-range-id",n),n(Page.Range.getValue("solver-steps-range-id"));var i=function(t){e.timestep=t};Page.Range.addObserver("timestep-range-id",i),i(Page.Range.getValue("timestep-range-id"));var o=function(e){c.stream=e};Page.Checkbox.addObserver("stream-checkbox-id",o),o(Page.Checkbox.isChecked("stream-checkbox-id"));var s=function(e){c.streamHeight=e};Page.Range.addObserver("source-height-id",s),s(Page.Range.getValue("source-height-id"));var u=function(e){l.radius=e};Page.Range.addObserver("brush-radius-range-id",u),u(Page.Range.getValue("brush-radius-range-id")),Page.Canvas.Observers.mouseWheel.push((function(e){Page.Range.setValue("brush-radius-range-id",l.radius+5*e),u(Page.Range.getValue("brush-radius-range-id"))}));var h=function(e){l.strength=e};Page.Range.addObserver("brush-strength-range-id",h),h(Page.Range.getValue("brush-strength-range-id"));var v=function(e){d.velocity="velocity"===e[0]||"velocity"===e[1],d.pressure="pressure"===e[0]||"pressure"===e[1]};Page.Tabs.addObserver("displayed-fields",v),v(Page.Tabs.getValues("displayed-fields"));var _=function(t){e.colorIntensity=t};Page.Range.addObserver("intensity-range-id",_),_(Page.Range.getValue("intensity-range-id"));var p=function(t){e.color=t};Page.Checkbox.addObserver("display-color-checkbox-id",p),p(Page.Checkbox.isChecked("display-color-checkbox-id"));var b=function(e){d.obstacles=e};Page.Checkbox.addObserver("display-obstacles-checkbox-id",b),b(Page.Checkbox.isChecked("display-obstacles-checkbox-id"));var m=function(e){f.radius=e};Page.Range.addObserver("blade-radius",m),m(Page.Range.getValue("blade-radius"));var g=function(e){f.centerOffset=e};Page.Range.addObserver("center-offset",g),g(Page.Range.getValue("center-offset"));var y=function(e){f.bladeCount=e};Page.Range.addObserver("blade-count",y),y(Page.Range.getValue("blade-count"))}(e),t.mouse=u=new s}},function(e,t,r){"use strict";var n,i=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var a=o(r(0));function s(e,t,r){alert("NOT IMPLEMENTED YET")}var u={35664:{str:"FLOAT_VEC2",binder:function(e,t,r){e.uniform2fv(t,r)}},35665:{str:"FLOAT_VEC3",binder:function(e,t,r){e.uniform3fv(t,r)}},35666:{str:"FLOAT_VEC4",binder:function(e,t,r){e.uniform4fv(t,r)}},35667:{str:"INT_VEC2",binder:function(e,t,r){e.uniform2iv(t,r)}},35668:{str:"INT_VEC3",binder:function(e,t,r){e.uniform3iv(t,r)}},35669:{str:"INT_VEC4",binder:function(e,t,r){e.uniform4iv(t,r)}},35670:{str:"BOOL",binder:function(e,t,r){e.uniform1i(t,+r)}},35671:{str:"BOOL_VEC2",binder:function(e,t,r){e.uniform2iv(t,r)}},35672:{str:"BOOL_VEC3",binder:function(e,t,r){e.uniform3iv(t,r)}},35673:{str:"BOOL_VEC4",binder:function(e,t,r){e.uniform4iv(t,r)}},35674:{str:"FLOAT_MAT2",binder:function(e,t,r){e.uniformMatrix2fv(t,!1,r)}},35675:{str:"FLOAT_MAT3",binder:function(e,t,r){e.uniformMatrix3fv(t,!1,r)}},35676:{str:"FLOAT_MAT4",binder:function(e,t,r){e.uniformMatrix4fv(t,!1,r)}},35678:{str:"SAMPLER_2D",binder:function(e,t,r,n){e.uniform1i(t,r),e.activeTexture(e["TEXTURE"+r]),e.bindTexture(e.TEXTURE_2D,n)}},35680:{str:"SAMPLER_CUBE",binder:function(e,t,r,n){e.uniform1i(t,r),e.activeTexture(e["TEXTURE"+r]),e.bindTexture(e.TEXTURE_CUBE_MAP,n)}},5120:{str:"BYTE",binder:s},5121:{str:"UNSIGNED_BYTE",binder:s},5122:{str:"SHORT",binder:s},5123:{str:"UNSIGNED_SHORT",binder:s},5124:{str:"INT",binder:function(e,t,r){Array.isArray(r),e.uniform1iv(t,r)}},5125:{str:"UNSIGNED_INT",binder:s},5126:{str:"FLOAT",binder:function(e,t,r){Array.isArray(r)?e.uniform1fv(t,r):e.uniform1f(t,r)}}},l=function(e){function t(t,r,n){var i=this;function o(e,r){var n=t.createShader(e);return t.shaderSource(n,r),t.compileShader(n),t.getShaderParameter(n,t.COMPILE_STATUS)?n:(t.deleteShader(n),null)}(i=e.call(this,t)||this).id=null,i.uCount=0,i.aCount=0;var a=o(t.VERTEX_SHADER,r),s=o(t.FRAGMENT_SHADER,n),u=t.createProgram();return t.attachShader(u,a),t.attachShader(u,s),t.linkProgram(u),t.getProgramParameter(u,t.LINK_STATUS)?(i.id=u,i.introspection()):t.deleteProgram(u),i}return i(t,e),t.prototype.freeGLResources=function(){e.prototype.gl.call(this).deleteProgram(this.id),this.id=null},t.prototype.introspection=function(){var t=e.prototype.gl.call(this);this.uCount=t.getProgramParameter(this.id,t.ACTIVE_UNIFORMS),this.u=[];for(var r=0;r<this.uCount;++r){var n=t.getActiveUniform(this.id,r),i=n.name;this.u[i]={value:null,loc:t.getUniformLocation(this.id,i),size:n.size,type:n.type}}this.aCount=t.getProgramParameter(this.id,t.ACTIVE_ATTRIBUTES),this.a=[];for(r=0;r<this.aCount;++r){var o=t.getActiveAttrib(this.id,r),a=o.name;this.a[a]={VBO:null,loc:t.getAttribLocation(this.id,a),size:o.size,type:o.type}}},t.prototype.use=function(){e.prototype.gl.call(this).useProgram(this.id)},t.prototype.bindUniforms=function(){var t=e.prototype.gl.call(this),r=0;for(var n in this.u){var i=this.u[n];if(null!==i.value)if(35678===i.type||35680===i.type){var o=r;u[i.type].binder(t,i.loc,o,i.value),r++}else u[i.type].binder(t,i.loc,i.value)}},t.prototype.bindAttributes=function(){for(var e in this.a){var t=this.a[e];null!==t.VBO&&t.VBO.bind(t.loc)}},t.prototype.bindUniformsAndAttributes=function(){this.bindUniforms(),this.bindAttributes()},t}(a.default);t.default=l},function(e,t,r){"use strict";var n,i=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(t,r,n,i){var o=e.call(this,t)||this;return o.id=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,o.id),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),o.size=n,o.type=i,o.normalize=!1,o.stride=0,o.offset=0,o}return i(t,e),t.prototype.freeGLResources=function(){this.gl().deleteBuffer(this.id),this.id=null},t.createQuad=function(e,r,n,i,o){return new t(e,new Float32Array([r,n,i,n,r,o,i,o]),2,e.FLOAT)},t.prototype.bind=function(t){var r=e.prototype.gl.call(this);r.enableVertexAttribArray(t),r.bindBuffer(r.ARRAY_BUFFER,this.id),r.vertexAttribPointer(t,this.size,this.type,this.normalize,this.stride,this.offset)},t}(o(r(0)).default);t.default=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ShaderSrc=t.fetch=void 0,t.fetch=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(),t.responseText};var n=function(){function e(e,t){this.vert=e,this.frag=t}return e.prototype.batchReplace=function(e){for(var t=0,r=e;t<r.length;t++){var n=r[t];this.vert=this.vert.replace(new RegExp(n.toReplace),n.replacement),this.frag=this.frag.replace(new RegExp(n.toReplace),n.replacement)}},e.fromScript=function(t,r){return new e(document.getElementById(t).text,document.getElementById(r).text)},e}();t.ShaderSrc=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.allExtensionsLoaded=t.loadExtensions=t.check=void 0,r(1),t.check=function(e){return!(e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision<23)||(Page.Demopage.setErrorMessage("webgl-requirements","Tu dispositivo solo soporta texturas de baja precisión.\nLa simulación no se puede ejecutar 😢."),!1)};var n=!1;t.allExtensionsLoaded=n,t.loadExtensions=function(e,r){t.allExtensionsLoaded=n=!0;for(var i=0,o=0,a=r;o<a.length;o++){var s=a[o];e.getExtension(s)||(Page.Demopage.setErrorMessage("no-ext"+i,"¡Oh! No pudimos cargar la extensión WebGL '"+s+"'."),t.allExtensionsLoaded=n=!1),++i}}},function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.encodingStr=t.buildAddShader=t.buildDrawShader=void 0;var i=n(r(4)),o=n(r(5)),a=r(6),s="vec4 encodeObstacle(vec2 normal) {\n  normal = clamp(normalize(normal), -1.0, 1.0);\n  return vec4(0.5 * normal + 0.5, 0, 0);\n}\nvec2 decodeObstacle(vec4 texel) {\n  return 2.0 * texel.rg - 1.0;\n}";t.encodingStr=s;var u=[{toReplace:"___ENCODING___",replacement:s}],l=new a.ShaderSrc("attribute vec2 aCorner; //{0,1}x{0,1}\nvarying vec2 sampleCoords;\n\nvoid main(void) {\n    sampleCoords = aCorner;\n    gl_Position = vec4(2.0*aCorner - 1.0, 0.0, 1.0);\n}","precision mediump float;\n\nuniform sampler2D uObstacles;\nvarying vec2 sampleCoords;\n\n___ENCODING___\n\nvoid main(void) {\n    vec2 obstacle = decodeObstacle(texture2D(uObstacles, sampleCoords));\n    if (dot(obstacle, obstacle) < 0.5)\n      discard;\n    gl_FragColor = vec4(1, 1, 1, 0);\n}");l.batchReplace(u);var c=new a.ShaderSrc("uniform vec2 uSize;  // relative, in [0,1] x [0,1]\nuniform vec2 uPos;      // relative, in [0,1] x [0,1]\nattribute vec2 aCorner; // in {-1,+1}x{-1,+1}\nvarying vec2 toCenter;\nuniform float uFaceOffset; // Offset so that all the blades face the same direction\nmat2 faceRot = mat2(cos(uFaceOffset), -sin(uFaceOffset), sin(uFaceOffset), cos(uFaceOffset));\nvoid main(void) {\n    toCenter = -aCorner;\n    vec2 pos =  uPos + faceRot*(aCorner * uSize);\n    gl_Position = vec4(2.0 * pos - 1.0, 0, 1);\n}","precision mediump float;\n  \nvarying vec2 toCenter;\nvarying vec2 cornerPos[4];\n\n\n___ENCODING___\n\nvoid main(void) {\n  float dist = length(toCenter);\n  if (dist > 1.0 || dist < 0.8 || toCenter.y < 0.0)\n    discard;\n  vec2 normal = -toCenter / (dist);\n  gl_FragColor = encodeObstacle(normal);\n\n}");c.batchReplace(u),t.buildDrawShader=function(e){var t=new i.default(e,l.vert,l.frag);return t.a.aCorner.VBO=o.default.createQuad(e,0,0,1,1),t},t.buildAddShader=function(e){var t=new i.default(e,c.vert,c.frag);return t.a.aCorner.VBO=o.default.createQuad(e,-1,-1,1,1),t}},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return i(t,e),t},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var s=o(r(10)),u=a(r(2)),l=o(r(3)),c=a(r(11)),d=a(r(13)),f=a(r(14)),h=o(r(7));r(1),function(){var e=function(e,t){function r(e){Page.Demopage.setErrorMessage("webgl-support",e)}var n=e.getContext("webgl",t);if(!n){if(!(n=e.getContext("experimental-webgl",t)))return r("Tu navegador o dispositivo no parece soportar WebGL 😢"),null;r("Tu navegador o dispositivo solo soporta una versión experimental de WebGL.\nLa simulación puede tener un comportamiento inesperado.")}return n&&(e.style.cursor="none",n.disable(n.CULL_FACE),n.disable(n.DEPTH_TEST),n.disable(n.BLEND),n.clearColor(0,0,0,1),s.resizeCanvas(n,!1)),n}(Page.Canvas.getCanvas(),{alpha:!1,antialias:!1});if(e&&h.check(e)){h.loadExtensions(e,["OES_texture_float","WEBGL_color_buffer_float","OES_texture_float_linear"]);var t=new f.default(e,1024,1024),r=new c.default(e),n=new d.default(e,1024,1024);l.bind(t);var i=0,o=0,a=0,v=0;setInterval((function(){Page.Canvas.setIndicatorText("fps",i.toFixed(0))}),1e3),setInterval((function(){Page.Canvas.setIndicatorText("power",o.toFixed(2)+" kW")}),1e3);var _=0;requestAnimationFrame((function s(c){var d=(c*=.001)-_;i=1/d,_=c,d=Math.min(d,.1),l.fluid.stream&&t.addVel([.1,.85-.5*l.fluid.streamHeight],[.05,l.fluid.streamHeight],[.04,0]),t.update(n),u.default.bindDefault(e),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),l.display.velocity?t.drawVelocity():l.display.pressure&&t.drawPressure(),l.display.brush&&r.draw(),l.display.obstacles&&n.draw(),v=n.computeTurbineTorque(t.samplePressure(),t.width,t.height),o=.002*v+.998*a,a=v,n.update(d,l.bladeInfo.bladeCount,l.bladeInfo.radius,l.bladeInfo.centerOffset),requestAnimationFrame(s)}))}}()},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.resizeCanvas=void 0,t.resizeCanvas=function(e,t){void 0===t&&(t=!1);var r=t?window.devicePixelRatio:1,n=e.canvas,i=Math.floor(n.clientWidth*r),o=Math.floor(n.clientHeight*r);n.width==i&&n.height==o||(n.width=i,n.height=o)}},function(e,t,r){"use strict";var n,i=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&o(t,e,r);return a(t,e),t},u=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var l=u(r(0)),c=s(r(3)),d=s(r(12)),f=function(e){function t(t){var r=e.call(this,t)||this;return r._drawShader=d.buildDrawShader(t),r.thickness=2,r}return i(t,e),t.prototype.freeGLResources=function(){this._drawShader.freeGLResources()},t.prototype.draw=function(){var t=e.prototype.gl.call(this),r=t.canvas,n=[r.clientWidth,r.clientHeight],i=this._drawShader;i.use();var o=[c.brush.radius/n[0],c.brush.radius/n[1]];i.u.uBrushSize.value=o,i.u.uBrushPos.value=c.mouse.pos,i.u.uThickness.value=this.thickness/c.brush.radius,i.bindUniformsAndAttributes(),t.drawArrays(t.TRIANGLE_STRIP,0,4)},t}(l.default);t.default=f},function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.buildDrawShader=void 0;var i=n(r(4)),o=n(r(5)),a=new(r(6).ShaderSrc)("uniform vec2 uBrushSize; //relative, in [0,1]x[0,1]\nuniform vec2 uBrushPos; //relative, in [0,1]x[0,1]\n\nattribute vec2 aCorner; //in {-1,+1}x{-1,+1}\n\nvarying vec2 toCenter;\n\nvoid main(void) {\n    toCenter = -aCorner;\n\n    vec2 pos = uBrushPos + aCorner * uBrushSize;\n\n    gl_Position = vec4(2.0 * pos - 1.0, 0, 1);\n}","precision mediump float;\n\nuniform float uThickness; //relative to brushRadius\n\nvarying vec2 toCenter;\n\nvoid main(void) {\n    float dist = length(toCenter);\n    if (dist < 1.0-uThickness || dist > 1.0)\n        discard;\n\n    const vec3 color = vec3(1);\n\n    gl_FragColor = vec4(color, 1.0);\n}");t.buildDrawShader=function(e){var t=new i.default(e,a.vert,a.frag);return t.a.aCorner.VBO=o.default.createQuad(e,-1,-1,1,1),t}},function(e,t,r){"use strict";var n,i=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&o(t,e,r);return a(t,e),t},u=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var l=u(r(0)),c=u(r(2)),d=s(r(8)),f=function(e){function t(t,r,n){var i=e.call(this,t)||this;return i._width=r,i._height=n,i._fbo=new c.default(t,r,n),i._drawShader=d.buildDrawShader(t),i._addShader=d.buildAddShader(t),i.initObstaclesMap(),i._angularVelocity=0,i._currentBladeCount=0,i._currentBladesInfo=[],i._angularPosition=0,i}return i(t,e),t.prototype.freeGLResources=function(){var t=e.prototype.gl.call(this);this._fbo.freeGLResources(),this._fbo=null,t.deleteTexture(this._texture),t.deleteTexture(this._initTexture),this._drawShader.freeGLResources(),this._addShader.freeGLResources(),this._drawShader=null,this._addShader=null},Object.defineProperty(t.prototype,"texture",{get:function(){return this._texture},enumerable:!1,configurable:!0}),t.prototype.draw=function(){var t=e.prototype.gl.call(this),r=this._drawShader;r.u.uObstacles.value=this._texture,r.use(),r.bindUniformsAndAttributes(),t.drawArrays(t.TRIANGLE_STRIP,0,4)},t.prototype.update=function(t,r,n,i){this.cleanPreviousFrame();var o=e.prototype.gl.call(this),a=this._addShader;this._currentBladesInfo.length!=r&&(this._currentBladesInfo=Array(r),this._currentBladeCount=r);for(var s=0;s<r;s++){var u=s/r*2*3.14159-this._angularPosition,l=(n+i)*Math.cos(u)+.5,c=(n+i)*Math.sin(u)+.5;a.u.uSize.value=[n,n],a.u.uPos.value=[l,c];var d=-u;a.u.uFaceOffset.value=d,this._currentBladesInfo[s]={x:l,y:c,radius:n,faceOffset:d,turbineCenterToBladeCenter:n+i},this._fbo.bind([this._texture]),a.use(),a.bindUniformsAndAttributes(),o.drawArrays(o.TRIANGLE_STRIP,0,4)}this._angularPosition+=this._angularVelocity*t%6.283185307},t.prototype.computeTurbineTorque=function(e,t,r){for(var n=0,i=0,o=this._currentBladesInfo;i<o.length;i++){for(var a=o[i],s=3.14159265-a.faceOffset,u=6.283185307-a.faceOffset,l=a.x,c=a.y,d=a.radius,f=a.turbineCenterToBladeCenter,h=.79*d,v=1.01*d,_=s;_<u;_+=3.14159265/50){var p=Math.sin(_),b=Math.cos(_),m=Math.floor(t*(l+h*b)),g=Math.floor(r*(c+h*p)),y=Math.floor(t*(l+v*b)),x=4*(t*g+m),E=4*(t*Math.floor(r*(c+v*p))+y);n+=(this.parsePressure(e.slice(x,x+4))*h-this.parsePressure(e.slice(E,E+4))*v)*(Math.sin(_-s)*f)*(3.14159265/50)}var T=.9*d,P=Math.floor(t*(l+T*Math.cos(s))),S=Math.floor(r*(c+T*Math.sin(s))),O=Math.floor(t*(l+T*Math.cos(u))),R=4*(t*S+P),D=4*(t*Math.floor(r*(c+T*Math.sin(u)))+O);n+=(this.parsePressure(e.slice(R,R+4))*(f-T)+this.parsePressure(e.slice(D,D+4))*(f+T))*(.2*d)}return this._angularVelocity=.995*Math.max(Math.min(this._angularVelocity+.05*n,1),-1),1e3*Math.abs(this._angularVelocity*n)},t.prototype.addObstacle=function(t,r){var n=e.prototype.gl.call(this),i=this._addShader;i.u.uSize.value=t,i.u.uPos.value=r,this._fbo.bind([this._texture]),i.use(),i.bindUniformsAndAttributes(),n.drawArrays(n.TRIANGLE_STRIP,0,4)},t.prototype.cleanPreviousFrame=function(){var t=e.prototype.gl.call(this);t.bindTexture(t.TEXTURE_2D,this._texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this._width,this._height,0,t.RGBA,t.UNSIGNED_BYTE,this._texelData),t.bindTexture(t.TEXTURE_2D,null)},t.prototype.parsePressure=function(e){return 1e-6*(((e[0]<<24|e[1]<<16|e[2]<<8|e[3])>>>0)-2147516416)},t.prototype.initObstaclesMap=function(){for(var t=e.prototype.gl.call(this),r=this._width,n=this._height,i=[],o=0;o<n;++o)for(var a=0;a<r;++a)0===o?i.push.apply(i,[127,255,0,255]):o===n-1?i.push.apply(i,[127,0,0,255]):0===a?i.push.apply(i,[255,127,0,255]):a===r-1?i.push.apply(i,[0,127,0,255]):i.push.apply(i,[127,127,0,255]);var s=new Uint8Array(i);this._texelData=s;for(var u=[],l=0;l<2;++l){var c=t.createTexture();t.bindTexture(t.TEXTURE_2D,c),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,r,n,0,t.RGBA,t.UNSIGNED_BYTE,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),u.push(c)}t.bindTexture(t.TEXTURE_2D,null),this._texture=u[0],this._initTexture=u[1]},t}(l.default);t.default=f},function(e,t,r){"use strict";var n,i=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&o(t,e,r);return a(t,e),t},u=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var l=u(r(0)),c=u(r(2)),d=s(r(3)),f=s(r(15));r(1);var h=function(e){function t(t,r,n){var i=e.call(this,t)||this;return i._useFloatTextures=!1,i.viscosity=2e-4,i.colorIntensity=.033,i.color=!0,i.reset(r,n),i}return i(t,e),t.prototype.freeGLResources=function(){this._FBO&&this._FBO.freeGLResources(),this.freeTextures(),this.freeShaders(),this._pressureSamplerBuffer&&e.prototype.gl.call(this).deleteFramebuffer(this._pressureSamplerBuffer)},t.prototype.freeTextures=function(){var t=e.prototype.gl.call(this);this._velTextures&&(t.deleteTexture(this._velTextures[0]),t.deleteTexture(this._velTextures[1])),t.deleteTexture(this._tmpTexture),t.deleteTexture(this._pressureTexture),t.deleteTexture(this._divergenceTexture)},Object.defineProperty(t.prototype,"width",{get:function(){return this._width},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!1,configurable:!0}),t.prototype.freeShaders=function(){function e(e){e&&e.freeGLResources()}e(this._drawVelocityShader),e(this._drawPressureShader),e(this._addVelShader),e(this._advectShader),e(this._jacobiPressureShader),e(this._divergenceShader),e(this._substractGradientShader),e(this._obstaclesVelocityShader)},t.prototype.reset=function(t,r){var n=e.prototype.gl.call(this);this.freeGLResources(),this._pressureSamplerBuffer=n.createFramebuffer(),this._width=t,this._height=r,this.dx=1/Math.min(t,r),this._FBO=new c.default(n,t,r),this.initTextures(),this.buildShaders(),this._currIndex=0},Object.defineProperty(t.prototype,"useFloatTextures",{set:function(e){e!==this._useFloatTextures&&(this._useFloatTextures=e,this.reset(this._width,this._height))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"minNbIterations",{set:function(e){this._nbIterations=2*Math.ceil(e/2)+1},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"texelSize",{get:function(){return[1/this._width,1/this._height]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"velTexture",{get:function(){return this._velTextures[this.currIndex]},enumerable:!1,configurable:!0}),t.prototype.update=function(t){var r=e.prototype.gl.call(this),n=this.timestep;if(r.clearColor(.5,0,.5,0),Page.Canvas.isMouseDown()){var i=r.canvas,o=[i.clientWidth,i.clientHeight],a=[d.brush.radius/o[0],d.brush.radius/o[1]],s=d.mouse.pos,u=[d.mouse.movement[0]*d.brush.strength,d.mouse.movement[1]*d.brush.strength];this.addVel(s,a,u)}this.advect(n),this.obstaclesVelocity(t),this.project(t),this.obstaclesVelocity(t)},t.prototype.addVel=function(e,t,r){var n=this.gl(),i=this._addVelShader;i.u.uVel.value=this._velTextures[this.currIndex],i.u.uBrushPos.value=e,i.u.uBrushSize.value=t,i.u.uAddVel.value=r,i.use(),this._FBO.bind([this._velTextures[this.nextIndex]]),i.bindUniformsAndAttributes(),n.drawArrays(n.TRIANGLE_STRIP,0,4),this.switchBuffers()},t.prototype.drawVelocity=function(){var e=this.gl(),t=this._drawVelocityShader;t.u.uVel.value=this._velTextures[this.currIndex],t.u.uColorIntensity.value=this.colorIntensity,t.u.uBlacknWhite.value=!this.color,t.use(),t.bindUniformsAndAttributes(),e.drawArrays(e.TRIANGLE_STRIP,0,4)},t.prototype.drawPressure=function(){var e=this.gl(),t=this._drawPressureShader;t.u.uPressure.value=this._pressureTexture,t.u.uColorIntensity.value=this.colorIntensity,t.u.uBlacknWhite.value=!this.color,t.use(),t.bindUniformsAndAttributes(),e.drawArrays(e.TRIANGLE_STRIP,0,4)},t.prototype.samplePressure=function(){var e=this.gl(),t=new Uint8Array(this._width*this._height*4);return e.bindFramebuffer(e.FRAMEBUFFER,this._pressureSamplerBuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this._pressureTexture,0),e.readPixels(0,0,this._width,this._height,e.RGBA,e.UNSIGNED_BYTE,t),e.bindFramebuffer(e.FRAMEBUFFER,null),t},Object.defineProperty(t.prototype,"currIndex",{get:function(){return this._currIndex},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"nextIndex",{get:function(){return(this._currIndex+1)%2},enumerable:!1,configurable:!0}),t.prototype.switchBuffers=function(){this._currIndex=this.nextIndex},t.prototype.obstaclesVelocity=function(e){var t=this.gl(),r=this._obstaclesVelocityShader;r.u.uVelocities.value=this._velTextures[this.currIndex],r.u.uObstacles.value=e.texture,r.u.uTexelSize.value=this.texelSize,this._FBO.bind([this._velTextures[this.nextIndex]]),r.use(),r.bindUniformsAndAttributes(),t.drawArrays(t.TRIANGLE_STRIP,0,4),this.switchBuffers()},t.prototype.advect=function(e){var t=this.gl(),r=this._advectShader;r.u.uVelUnit.value=[128/this._width,128/this._height],r.u.uDt.value=e,r.u.uQuantity.value=this._velTextures[this.currIndex],r.u.uVel.value=this._velTextures[this.currIndex],this._FBO.bind([this._velTextures[this.nextIndex]]),r.use(),r.bindUniformsAndAttributes(),t.drawArrays(t.TRIANGLE_STRIP,0,4),this.switchBuffers()},t.prototype.computeDivergence=function(){var e=this.gl(),t=this._divergenceShader;t.u.uTexelSize.value=this.texelSize,t.u.uVelocity.value=this._velTextures[this.currIndex],this._FBO.bind([this._divergenceTexture]),e.clear(e.COLOR_BUFFER_BIT),t.use(),t.bindUniformsAndAttributes(),e.drawArrays(e.TRIANGLE_STRIP,0,4)},t.prototype.computePressure=function(e){var t=this.gl(),r=this._jacobiPressureShader,n=-.5*this.dx,i=this._pressureTexture,o=this._divergenceTexture;r.u.uTexelSize.value=this.texelSize,r.u.uAlpha.value=n,r.u.uInvBeta.value=1/4,r.u.uConstantTerm.value=o,r.u.uObstacles.value=e.texture;var a=0,s=[this._tmpTexture,i];this._FBO.bind([this._tmpTexture]),t.clear(t.COLOR_BUFFER_BIT),r.use(),r.bindAttributes();for(var u=0;u<this._nbIterations;++u)r.u.uPrevIter.value=s[a],this._FBO.bind([s[(a+1)%2]]),r.bindUniforms(),t.drawArrays(t.TRIANGLE_STRIP,0,4),a=(a+1)%2},t.prototype.substractPressureGradient=function(){var e=this.gl(),t=this._substractGradientShader;t.u.uVelocities.value=this._velTextures[this.currIndex],t.u.uPressure.value=this._pressureTexture,t.u.uTexelSize.value=this.texelSize,t.u.uHalfInvDx.value=.5/this.dx,this._FBO.bind([this._velTextures[this.nextIndex]]),t.use(),t.bindUniformsAndAttributes(),e.drawArrays(e.TRIANGLE_STRIP,0,4),this.switchBuffers()},t.prototype.project=function(e){this.computeDivergence(),this.computePressure(e),this.substractPressureGradient()},t.prototype.initTextures=function(){this.freeTextures();for(var t=e.prototype.gl.call(this),r=this._width,n=this._height,i=[],o=0;o<4*r*n;++o)i.push(0);var a=new Float32Array(i),s=[];for(o=0;o<4*r*n;++o)s.push(127);var u=new Uint8Array(s),l=this._useFloatTextures?t.FLOAT:t.UNSIGNED_BYTE,c=this._useFloatTextures?a:u,d=[];for(o=0;o<2;++o){var f=t.createTexture();t.bindTexture(t.TEXTURE_2D,f),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,r,n,0,t.RGBA,l,c),d.push(f)}for(o=0;o<3;++o){f=t.createTexture();t.bindTexture(t.TEXTURE_2D,f),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,r,n,0,t.RGBA,t.UNSIGNED_BYTE,u),d.push(f)}for(var h=0,v=d;h<v.length;h++){f=v[h];t.bindTexture(t.TEXTURE_2D,f),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)}t.bindTexture(t.TEXTURE_2D,null),this._velTextures=[d[0],d[1]],this._tmpTexture=d[2],this._pressureTexture=d[3],this._divergenceTexture=d[4]},t.prototype.buildShaders=function(){this.freeShaders(),f.setUseFloatTextures(this._useFloatTextures);var t=e.prototype.gl.call(this);this._drawVelocityShader=f.buildDrawVelocityShader(t),this._drawPressureShader=f.buildDrawPressureShader(t),this._addVelShader=f.buildAddVelShader(t),this._advectShader=f.buildAdvectShader(t),this._jacobiPressureShader=f.buildJacobiPressureShader(t),this._divergenceShader=f.buildDivergenceShader(t),this._substractGradientShader=f.buildSubstractGradientShader(t),this._obstaclesVelocityShader=f.buildObstaclesVelocityShader(t)},t}(l.default);t.default=h},function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.setUseFloatTextures=t.buildObstaclesVelocityShader=t.buildSubstractGradientShader=t.buildDivergenceShader=t.buildJacobiPressureShader=t.buildAdvectShader=t.buildAddVelShader=t.buildDrawPressureShader=t.buildDrawVelocityShader=void 0;var i=n(r(4)),o=n(r(5)),a=r(6),s=r(8),u="\nconst float MAX_SPEED = 1.0;\nconst float SPEED_BANDWIDTH = 2.01 * MAX_SPEED;\n\nconst float MIN_DIVERGENCE = -4.0 * MAX_SPEED;\nconst float MAX_DIVERGENCE =  4.0 * MAX_SPEED;\nconst float DIVERGENCE_BANDWIDTH = MAX_DIVERGENCE - MIN_DIVERGENCE;\n\nconst float MIN_PRESSURE = 0.5 * MIN_DIVERGENCE;\nconst float MAX_PRESSURE = 0.5 * MAX_DIVERGENCE;\nconst float PRESSURE_BANDWIDTH = MAX_PRESSURE - MIN_PRESSURE;\n\n/* Decodes a float value (32 bits in [0,1])\n * from a 4D value (4x8bits in [0,1]x[0,1]x[0,1]x[0,1]) */\nfloat decode32bit(vec4 v)\n{\n    const vec4 weights = 255.0 * vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0) / (256.0*256.0*256.0*256.0 - 1.0);\n    return dot(weights, v);\n}\n\n/* Encodes a float value (32 bits in [0,1])\n * into a 4D value (4x8bits in [0,1]x[0,1]x[0,1]x[0,1]) */\nvec4 encode32bit(float f)\n{\n    const vec4 base = (256.0*256.0*256.0*256.0 - 1.0) / vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\n    return floor(mod(f * base, 256.0)) / 255.0;\n}\n\n/* Decodes a float value (16 bits in [0,1])\n * from a 2D value (2x8bits in [0,1]x[0,1]) */\nfloat decode16bit(vec2 v)\n{\n    const vec2 weights = 255.0 * vec2(256.0, 1.0) / (256.0*256.0 - 1.0);\n    return dot(weights, v);\n}\n\n/* Encodes a float value (16 bits in [0,1])\n * into a 2D value (2x8bits in [0,1]x[0,1]) */\nvec2 encode16bit(float f)\n{\n    const vec2 base = (256.0*256.0 - 1.0) / vec2(256.0, 1.0);\n    return floor(mod(f * base, 256.0)) / 255.0;\n}\n\nfloat decodeDivergence(vec4 texel) {\n    float div = decode32bit(texel);\n    return div * DIVERGENCE_BANDWIDTH + MIN_DIVERGENCE;\n}\nvec4 encodeDivergence(float div) {\n    div = (div - MIN_DIVERGENCE) / DIVERGENCE_BANDWIDTH;\n    return encode32bit(div);\n}\n\nfloat decodePressure(vec4 texel) {\n    float p = decode32bit(texel);\n    return p * PRESSURE_BANDWIDTH + MIN_PRESSURE;\n}\nvec4 encodePressure(float p) {\n    p = (p - MIN_PRESSURE) / PRESSURE_BANDWIDTH;\n    return encode32bit(p);\n}\n\n___ENCODING_VELOCITY___\n\n___ENCODING_OBSTACLES___",l="attribute vec2 aCorner; //{0,1}x{0,1}\n\nvarying vec2 sampleCoords;\n\nvoid main(void) {\n    sampleCoords = aCorner;\n    gl_Position = vec4(2.0*aCorner - 1.0, 0.0, 1.0);\n}",c=u;function d(e){c=(c=u.replace(/___ENCODING_VELOCITY___/g,e?"vec4 encodeVelocity(vec2 vel) {\n    return vec4(vel, 0, 0);\n}\nvec2 decodeVelocity(vec4 texel) {\n    return texel.rg;\n}":"vec4 encodeVelocity(vec2 vel) {\n    vel = 0.5 * (vel / MAX_SPEED + 1.0);\n    return vec4(encode16bit(vel.x), encode16bit(vel.y));\n}\nvec2 decodeVelocity(vec4 texel) {\n    vec2 vel = vec2(decode16bit(texel.rg), decode16bit(texel.ba));\n    return (2.0 * vel - 1.0) * MAX_SPEED;\n}")).replace(/___ENCODING_OBSTACLES___/g,s.encodingStr)}d(!1),t.setUseFloatTextures=d;var f=new a.ShaderSrc(l,"precision mediump float;\n\nuniform sampler2D uVel;\nuniform float uColorIntensity;\nuniform bool uBlacknWhite;\n\nvarying vec2 sampleCoords;\n\n___ENCODING___\n\n/*\n   /---__/     __\n 0 1 2 3 4\n*/\nfloat bump(float x) {\n  return min(mix(0.0, 1.0, clamp(x, 0.0, 1.0)),\n             mix(1.0, 0.0, clamp(x-3.0, 0.0, 1.0)));\n}\n\n/* Every hue, periodic with a period of 1 */\nvec3 color(float value) {\n    value *= 6.0;\n    float r = bump(mod(value-4.0, 6.0));\n    float g = bump(mod(value-0.0, 6.0));\n    float b = bump(mod(value-2.0, 6.0));\n    return vec3(r,g,b);\n}\n\nvoid main(void) {\n    vec2 vel = decodeVelocity(texture2D(uVel, sampleCoords)) / MAX_SPEED;\n\n    vec3 c = color(atan(vel.y, vel.x) / (2.0 * 3.14159));\n    c = mix(c, vec3(1), float(uBlacknWhite));\n\n    float intensity = smoothstep(0.0, 1.0, uColorIntensity*length(vel));\n\n    gl_FragColor = vec4(intensity * c, 1);\n}"),h=new a.ShaderSrc(l,"precision mediump float;\n\nuniform sampler2D uPressure;\nuniform float uColorIntensity;\nuniform bool uBlacknWhite;\n\nvarying vec2 sampleCoords;\n\n___ENCODING___\n\nvec3 color(float value) {\n    value = smoothstep(0.0, 1.0, clamp(value, 0.0, 1.0));\n    value = smoothstep(0.0, 1.0, value);\n\n    float r = smoothstep(.5, .75, value);\n    float g = min(smoothstep(.0, .25, value),\n                  1.0 - smoothstep(.75, 1.0, value));\n    float b = 1.0 - smoothstep(.25, .5, value);\n    return vec3(r,g,b);\n}\n\nvoid main(void) {\n    float pressure = decodePressure(texture2D(uPressure, sampleCoords));\n    pressure = pressure / MAX_PRESSURE;\n    pressure = clamp(256.0*uColorIntensity*pressure, -.5, .5) + 0.5;\n\n    vec3 c = color(pressure);\n    c = mix(c, vec3(pressure), float(uBlacknWhite));\n\n    gl_FragColor = vec4(c, 1);\n}"),v=new a.ShaderSrc("uniform vec2 uBrushSize; //relative, in [0,1]x[0,1]\nuniform vec2 uBrushPos; //relative, in [0,1]x[0,1]\n\nattribute vec2 aCorner; //{0,1}x{0,1}\n\nvarying vec2 sampleCoords;\nvarying vec2 toBrush;\n\nvoid main(void) {\n    sampleCoords = aCorner;\n    toBrush = (uBrushPos - aCorner) / uBrushSize;\n\n    gl_Position = vec4(2.0*aCorner - 1.0, 0.0, 1.0);\n}","precision mediump float;\n\nuniform sampler2D uVel;\n\nuniform vec2 uAddVel;\n\nvarying vec2 sampleCoords;\nvarying vec2 toBrush;\n\n___ENCODING___\n\nvoid main(void) {\n    vec2 vel = decodeVelocity(texture2D(uVel, sampleCoords));\n\n    float influence = 1.0 - clamp(length(toBrush), 0.0, 1.0);\n    vec2 toAdd = influence * uAddVel;\n\n    vel += toAdd;\n    vel *= min(1.0, MAX_SPEED / length(vel));\n\n    gl_FragColor = encodeVelocity(vel);\n}"),_=new a.ShaderSrc(l,"precision mediump float;\n\nuniform sampler2D uQuantity; //thing to advect\nuniform sampler2D uVel;\n\nuniform vec2 uVelUnit;\nuniform float uDt;\n\nvarying vec2 sampleCoords;\n\n___ENCODING___\n\nvoid main(void) {\n    vec2 vel = decodeVelocity(texture2D(uVel, sampleCoords));\n    vec2 pos = sampleCoords - uDt * vel * uVelUnit;\n    gl_FragColor = texture2D(uQuantity, pos);\n}"),p=new a.ShaderSrc(l,"precision mediump float;\n\nuniform sampler2D uPrevIter; //x\nuniform sampler2D uConstantTerm; //b\nuniform sampler2D uObstacles;\n\nuniform float uAlpha;\nuniform float uInvBeta;\n\nuniform vec2 uTexelSize;\n\nvarying vec2 sampleCoords;\n\n___ENCODING___\n\nvoid main(void) {\n    vec2 obstacle = decodeObstacle(texture2D(uObstacles,  sampleCoords));\n    vec2 coords = sampleCoords + uTexelSize * obstacle;\n\n    float result = decodePressure(texture2D(uPrevIter, coords - vec2(uTexelSize.x,0))) +\n                   decodePressure(texture2D(uPrevIter, coords + vec2(uTexelSize.x,0))) +\n                   decodePressure(texture2D(uPrevIter, coords - vec2(0,uTexelSize.y))) +\n                   decodePressure(texture2D(uPrevIter, coords + vec2(0,uTexelSize.y)));\n\n    result += uAlpha * decodeDivergence(texture2D(uConstantTerm, coords));\n    result *= uInvBeta;\n    result = clamp(result, MIN_PRESSURE, MAX_PRESSURE);\n\n    gl_FragColor = encodePressure(result);\n}"),b=new a.ShaderSrc(l,"precision mediump float;\n\nuniform sampler2D uVelocity;\n\nuniform vec2 uTexelSize;\n\nvarying vec2 sampleCoords;\n\n___ENCODING___\n\nvoid main(void) {\n    vec2 top =    decodeVelocity(texture2D(uVelocity, sampleCoords + vec2(0,uTexelSize.y)));\n    vec2 bottom = decodeVelocity(texture2D(uVelocity, sampleCoords - vec2(0,uTexelSize.y)));\n    vec2 left =   decodeVelocity(texture2D(uVelocity, sampleCoords - vec2(uTexelSize.x,0)));\n    vec2 right =  decodeVelocity(texture2D(uVelocity, sampleCoords + vec2(uTexelSize.x,0)));\n\n    float div = ((right.x - left.x) + (top.y - bottom.y));\n    div *= min(1.0, MAX_DIVERGENCE / length(div));\n\n    gl_FragColor = encodeDivergence(div);\n}"),m=new a.ShaderSrc(l,"precision mediump float;\n\nuniform sampler2D uVelocities;\nuniform sampler2D uPressure;\n\nuniform vec2 uTexelSize;\nuniform float uHalfInvDx;\n\nvarying vec2 sampleCoords;\n\n___ENCODING___\n\nvoid main(void) {\n    float top =    decodePressure(texture2D(uPressure, sampleCoords + vec2(0,uTexelSize.y)));\n    float bottom = decodePressure(texture2D(uPressure, sampleCoords - vec2(0,uTexelSize.y)));\n    float left =   decodePressure(texture2D(uPressure, sampleCoords - vec2(uTexelSize.x,0)));\n    float right =  decodePressure(texture2D(uPressure, sampleCoords + vec2(uTexelSize.x,0)));\n\n    vec2 grad = uHalfInvDx * vec2(right - left, top - bottom);\n\n    vec2 partialVel = decodeVelocity(texture2D(uVelocities, sampleCoords));\n    vec2 divFreeVel = partialVel - grad;\n    divFreeVel *= min(1.0, MAX_SPEED / length(divFreeVel));\n\n    gl_FragColor = encodeVelocity(divFreeVel);\n}"),g=new a.ShaderSrc(l,"precision mediump float;\n\nuniform sampler2D uVelocities;\nuniform sampler2D uObstacles;\nuniform vec2 uTexelSize;\n\nvarying vec2 sampleCoords;\n\n___ENCODING___\n\nvoid main(void) {\n    vec2 obstacle = decodeObstacle(texture2D(uObstacles,  sampleCoords));\n    vec2 coords = sampleCoords + obstacle * uTexelSize;\n\n    vec2 vel = decodeVelocity(texture2D(uVelocities, coords));\n    vel *= sign(0.5 - dot(obstacle,obstacle));\n    \n    gl_FragColor = encodeVelocity(vel);\n}");function y(e,t){var r=t.vert,n=t.frag.replace(/___ENCODING___/g,c),a=new i.default(e,r,n);return a.a.aCorner.VBO=o.default.createQuad(e,0,0,1,1),a}t.buildDrawVelocityShader=function(e){return y(e,f)},t.buildDrawPressureShader=function(e){return y(e,h)},t.buildAddVelShader=function(e){return y(e,v)},t.buildAdvectShader=function(e){return y(e,_)},t.buildJacobiPressureShader=function(e){return y(e,p)},t.buildDivergenceShader=function(e){return y(e,b)},t.buildSubstractGradientShader=function(e){return y(e,m)},t.buildObstaclesVelocityShader=function(e){return y(e,g)}}]);